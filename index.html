<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <title>DApp Market</title>
    <meta name="description" content="">
    <link rel="stylesheet" href="lib/index.css">
    </head>
    <body>
        <header>
            <section>
                <label for="title">DApp Market</label>
            </section>
        </header>
        <section>
            <div class="noExtension hide" id="noExtension">
                提示: 请安装
                <a target="_blank" href="https://github.com/ChengOrangeJu/WebExtensionWallet">WebExtensionWallet</a> 再使用DApp Market
            </div>
        </section>
        <section>
            <ul class="dapp-list">
                <div class="loading-container">
                    <div class="loading">
                        <img src="./images/loading.gif">
                    </div>
                </div>
                <!-- <li class="dapp-item dapp-item-bg-1">
                    <a href="#">
                        <div class="dapp-img">
                            <img src="./images/nebulas.png">
                        </div>
                        <div class="text-content">
                            <h3 class="text-title">Hhhhhh</h3>
                            <div class="text-des">
                                HhhhhhHhhhhhHhhhhhHhhhhhhh
                            </div>
                        </div>
                    </a>        
                </li>
                <li class="dapp-item dapp-item-bg-2">
                    <div class="dapp-img">
                        <img src="./images/nebulas.png">
                    </div>
                    <div class="text-content">
                        <h3 class="text-title">Hhhhhh</h3>
                        <div class="text-des">
                            HhhhhhHhhhhhHhhhhhhhhHhhhhhhh
                        </div>
                    </div>        
                </li>
                <li class="dapp-item dapp-item-bg-3">
                    <div class="dapp-img">
                        <img src="./images/nebulas.png">
                    </div>
                    <div class="text-content">
                        <h3 class="text-title">Hhhhhh</h3>
                        <div class="text-des">
                            HhhhhhHhhhhhHhhhhhHHhhhh
                        </div>
                    </div>        
                </li>
                <li class="dapp-item dapp-item-bg-4">
                    <div class="dapp-img">
                        <img src="./images/nebulas.png">
                    </div>
                    <div class="text-content">
                        <h3 class="text-title">Hhhhhh</h3>
                        <div class="text-des">
                            HhhhhhHhhhhhHhhhhhHhhhhhhHhhhhh
                        </div>
                    </div>        
                </li>
                <li class="dapp-item dapp-item-bg-5">
                    <div class="dapp-img">
                        <img src="./images/nebulas.png">
                    </div>
                    <div class="text-content">
                        <h3 class="text-title">Hhhhhh</h3>
                        <div class="text-des">
                            HhhhhhHhhhhhHhhhhhHh
                        </div>
                    </div>        
                </li>
                <li class="dapp-item dapp-item-bg-6">
                    <div class="dapp-img">
                        <img src="./images/nebulas.png">
                    </div>
                    <div class="text-content">
                        <h3 class="text-title">Hhhhhh</h3>
                        <div class="text-des">
                            HhhhhhHhhhhhHhhhhhHhhhhh
                        </div>
                    </div>        
                </li>
                <li class="dapp-item dapp-item-bg-7">
                    <div class="dapp-img">
                        <img src="./images/nebulas.png">
                    </div>
                    <div class="text-content">
                        <h3 class="text-title">Hhhhhh</h3>
                        <div class="text-des">
                            HhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhh
                        </div>
                    </div>        
                </li>
                <li class="dapp-item dapp-item-bg-8">
                    <div class="dapp-img">
                        <img src="./images/nebulas.png">
                    </div>
                    <div class="text-content">
                        <h3 class="text-title">Hhhhhh</h3>
                        <div class="text-des">
                            HhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhh
                        </div>
                    </div>        
                </li>
                <li class="dapp-item dapp-item-bg-9">
                    <div class="dapp-img">
                        <img src="./images/nebulas.png">
                    </div>
                    <div class="text-content">
                        <h3 class="text-title">Hhhhhh</h3>
                        <div class="text-des">
                            HhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhh
                        </div>
                    </div>        
                </li>
                <li class="dapp-item dapp-item-bg-10">
                    <div class="dapp-img">
                        <img src="./images/nebulas.png">
                    </div>
                    <div class="text-content">
                        <h3 class="text-title">Hhhhhh</h3>
                        <div class="text-des">
                            HhhhhhHhhhhhHhhhhhHhhhhhHHhhhhhHhhhhhHhhhhhHhhHhhhhhHhhhhhHhhhhhHhhHhhhhhHhhhhhHhhhhhHhhHhhhhhHhhhhhHhhhhhHhhhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhhHhhhhh
                        </div>
                    </div>        
                </li> -->
            </ul>
            <div class="page-btn-container">
                <button class="page-btn page-btn-pre">上一页</button>
                <button class="page-btn page-btn-next">下一页</button>
            </div>
        </section>
        <section>
            <div class="dapp-pubilsh">
                <h1 class="dapp-title">提交Dapp信息</h1>
                <div class="dapp-form">
                    <div class="form-item">
                        <input type="text" class="form-title" placeholder="请输入Dapp的名称">
                    </div>
                    <div class="form-item">
                        <input type="text" class="form-url" placeholder="请输入Dapp的链接 以http或https开头">
                    </div>
                    <div class="form-item">
                        <textarea class="form-desc" placeholder="请输入Dapp的描述"></textarea>
                    </div>
                    <div class="form-item">
                        <button class="form-btn">提   交</button>
                    </div>
                </div>
            </div>
        </section>
        <footer>
            Copyright © 2018.DApp Market 使用 <a href="https://nebulas.io/" target="_black">星云链</a> 驱动 |  <a href="https://incentive.nebulas.io/cn/signup.html?invite=To5wY" target="_black">提交DAPP获得 100NAS 币</a>
        </footer>
        <script src=lib/jquery-3.3.1.min.js></script>
        <script src=lib/nebPay.js></script>
        <script src=lib/nebulas.js></script>
        <script>
        setTimeout(function () {
            if(typeof(webExtensionWallet) === "undefined"){
                $("#noExtension").removeClass("hide")
            };
        }, 200);
        //模拟数据库，获取信息
        var pageCnt = 10;
        var page = 0;
        var pageIndex = pageCnt*page;
        var last = false;
        $(".page-btn-pre").click(function(e){
            if(page<=0)return;
            page = page-1;
            getData(pageCnt,pageIndex);
        });
        $(".page-btn-next").click(function(e){
            if(last)return;
            page = page+1;
            var pageIndex = pageCnt*page;
            getData(pageCnt,pageIndex);
        });
        function cbSearch(resp){
            console.log(resp);
            var messages = JSON.parse(resp.result);
            //获取相关元素
            var domDappList = $(".dapp-list");
            var content="";
            var len = messages.length;
            if(len<pageCnt){
                last = true;
            }
            if(len==0)return
            for(var i=0;i<len;i++){
                var bgIndex = i+1;
                content += '<li class="dapp-item dapp-item-bg-'+bgIndex+'">' +
                    '<a href="' + messages[i].link + '">' +
                        '<div class="dapp-img">' +
                            '<img src="./images/nebulas.png">' +
                        '</div>' +
                        '<div class="text-content">' +
                            '<h3 class="text-title" title="'+ messages[i].name +'">' + messages[i].name + '</h3>' +
                            '<div class="text-des" title="' + messages[i].content + '">' +
                                messages[i].content +
                            '</div>' +
                        '</div>' +
                    '</a>' +      
                '</li>';
            }
            domDappList.html(content);
        }
    
        //调用职能合约
        var dappAddress = "n1xLJkK5ikzuDMzi2JmE8Aqm2HEc7nepfXy";

        var nebulas = require("nebulas"),
            Account = nebulas.Account,
            neb = new nebulas.Neb();
        neb.setRequest(new nebulas.HttpRequest("https://mainnet.nebulas.io"));

        function getData(cnt, index){
            var from = Account.NewAccount().getAddressString();
            var value = "0";
            var nonce = "0"
            var gas_price = "1000000"
            var gas_limit = "2000000"
            var callFunction = "forEach";
            var callArgs = "[\"" + cnt + "\", \""+ index + "\"]"; //in the form of ["args"]
            var contract = {
                "function": callFunction,
                "args": callArgs
            }

            neb.api.call(from,dappAddress,value,nonce,gas_price,gas_limit,contract).then(function (resp) {
                cbSearch(resp)
            }).catch(function (err) {
                //cbSearch(err)
                console.log("error:" + err.message)
            })
        }
        getData(pageCnt,pageIndex);

        var NebPay = require("nebpay");     //https://github.com/nebulasio/nebPay
        var nebPay = new NebPay();
        var serialNumber
        var reg=/(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?/;
        $(".form-btn").click(function() {

            var to = dappAddress;
            var value = "0";
            var callFunction = "save";
            var date = new Date().toDateString();
            var url = $(".form-url").val();
            var desc = $(".form-desc").val();
            if(!reg.test(url)){
                alert('请输入有效网站地址！');
                return;
            }
            var callArgs = "[\"" + $(".form-title").val() + "\",\"" + url + "\",\"" + desc + "\",\"" + date + "\"]";

            serialNumber = nebPay.call(to, value, callFunction, callArgs, {    //使用nebpay的call接口去调用合约,
                listener: cbPush        //设置listener, 处理交易返回信息
            });
            //console.log(serialNumber)
            intervalQuery = setInterval(function () {
                funcIntervalQuery();
            }, 5000);
        });

        var intervalQuery

        function funcIntervalQuery() {
            //console.log(serialNumber)
            nebPay.queryPayInfo(serialNumber)   //search transaction result from server (result upload to server by app)
                .then(function (resp) {
                    console.log("tx result: " + resp)   //resp is a JSON string
                    var respObject = JSON.parse(resp)
                    if(respObject.code === 0){
                        window.location.href=window.location.href;
                        clearInterval(intervalQuery)
                    }
                })
                .catch(function (err) {
                    console.log(err);
                });
        }

        function cbPush(resp) {
            console.log("response of push: " + JSON.stringify(resp))
        }
    </script>
</body>
</html>